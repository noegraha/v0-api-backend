{
    "sourceFile": "api/pusher/auth.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 12,
            "patches": [
                {
                    "date": 1764814520744,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764826262212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,44 @@\n+import Pusher from \"pusher\";\r\n+import { applyCors } from '../_cors.js';\r\n+\r\n+export const config = {\r\n+    runtime: \"nodejs\",\r\n+};\r\n+\r\n+const pusher = new Pusher({\r\n+    appId: process.env.PUSHER_APP_ID,\r\n+    key: process.env.PUSHER_KEY,\r\n+    secret: process.env.PUSHER_SECRET,\r\n+    cluster: process.env.PUSHER_CLUSTER,\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") {\r\n+        return res.status(200).end();\r\n+    }\r\n+\r\n+    if (req.method !== \"POST\") {\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+    }\r\n+\r\n+    const { socket_id, channel_name, user_id, username, ip, host } = req.body;\r\n+\r\n+    if (!user_id || !username) {\r\n+        return res.status(400).json({ error: \"Missing user data\" });\r\n+    }\r\n+\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username,\r\n+            ip: ip || \"-\",\r\n+            host: host || \"-\",\r\n+        },\r\n+    };\r\n+\r\n+    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n+    res.send(auth);\r\n+}\r\n"
                },
                {
                    "date": 1764827136036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,35 @@\n+import Pusher from \"pusher\";\r\n+import { applyCors } from '../_cors.js';\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+const pusher = new Pusher({\r\n+    appId: process.env.PUSHER_APP_ID,\r\n+    key: process.env.PUSHER_KEY,\r\n+    secret: process.env.PUSHER_SECRET,\r\n+    cluster: process.env.PUSHER_CLUSTER,\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, username, name, ip, host, time } = req.body;\r\n+\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString(), // server-generated real time\r\n+        }\r\n+    };\r\n+\r\n+    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n+    res.send(auth);\r\n+}\r\n"
                },
                {
                    "date": 1765163876131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,15 +1,23 @@\n+// auth.js ‚Äî versi Ably Pusher-Compatible\r\n import Pusher from \"pusher\";\r\n import { applyCors } from '../_cors.js';\r\n \r\n export const config = { runtime: \"nodejs\" };\r\n \r\n+// Gunakan REST endpoint Ably dengan Pusher Protocol\r\n const pusher = new Pusher({\r\n-    appId: process.env.PUSHER_APP_ID,\r\n-    key: process.env.PUSHER_KEY,\r\n-    secret: process.env.PUSHER_SECRET,\r\n-    cluster: process.env.PUSHER_CLUSTER,\r\n+    appId: process.env.ABLY_APP_ID,\r\n+    key: process.env.ABLY_KEY_ID,       // KEY bagian depan sebelum \":\"\r\n+    secret: process.env.ABLY_KEY_SECRET, // SECRET bagian belakang setelah \":\"\r\n     useTLS: true,\r\n+\r\n+    // OVERRIDE HOST KE ABLY\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+\r\n+    // Cluster TIDAK DIPAKAI di Ably, jadi jangan isi\r\n });\r\n \r\n export default async function handler(req, res) {\r\n     applyCors(res);\r\n@@ -25,11 +33,16 @@\n             username: username || name,\r\n             name: name || username,\r\n             ip: ip ?? \"-\",\r\n             host: host ?? \"-\",\r\n-            time: time ?? new Date().toISOString(), // server-generated real time\r\n+            time: time ?? new Date().toISOString()\r\n         }\r\n     };\r\n \r\n-    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n-    res.send(auth);\r\n+    try {\r\n+        const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        console.error(\"ABLY AUTH ERROR:\", err);\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n }\r\n"
                },
                {
                    "date": 1765175764119,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,44 @@\n+// auth.js ‚Äî versi Ably Pusher-Compatible\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from '../_cors.js';\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// Gunakan REST endpoint Ably dengan Pusher Protocol\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID,\r\n+    key: process.env.ABLY_KEY_ID,\r\n+    secret: process.env.ABLY_KEY_SECRET,\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, username, name, ip, host, time } = req.body;\r\n+\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString()\r\n+        }\r\n+    };\r\n+\r\n+    try {\r\n+        const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        console.error(\"ABLY AUTH ERROR:\", err);\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765175999655,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,11 +5,11 @@\n export const config = { runtime: \"nodejs\" };\r\n \r\n // Gunakan REST endpoint Ably dengan Pusher Protocol\r\n const pusher = new Pusher({\r\n-    appId: process.env.ABLY_APP_ID,\r\n-    key: process.env.ABLY_KEY_ID,\r\n-    secret: process.env.ABLY_KEY_SECRET,\r\n+    appId: process.env.ABLY_APP_ID,            // R2yUfw\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`,\r\n+    secret: process.env.ABLY_KEY_SECRET,       // shDrY-...\r\n     host: \"rest-pusher.ably.io\",\r\n     port: 443,\r\n     scheme: \"https\",\r\n     useTLS: true,\r\n@@ -41,132 +41,4 @@\n         console.error(\"ABLY AUTH ERROR:\", err);\r\n         return res.status(500).json({ error: \"Auth failed\" });\r\n     }\r\n }\r\n-// auth.js ‚Äî versi Ably Pusher-Compatible\r\n-import Pusher from \"pusher\";\r\n-import { applyCors } from '../_cors.js';\r\n-\r\n-export const config = { runtime: \"nodejs\" };\r\n-\r\n-// Gunakan REST endpoint Ably dengan Pusher Protocol\r\n-const pusher = new Pusher({\r\n-    appId: process.env.ABLY_APP_ID,\r\n-    key: process.env.ABLY_KEY_ID,       // KEY bagian depan sebelum \":\"\r\n-    secret: process.env.ABLY_KEY_SECRET, // SECRET bagian belakang setelah \":\"\r\n-    useTLS: true,\r\n-\r\n-    // OVERRIDE HOST KE ABLY\r\n-    host: \"rest-pusher.ably.io\",\r\n-    port: 443,\r\n-    scheme: \"https\",\r\n-\r\n-    // Cluster TIDAK DIPAKAI di Ably, jadi jangan isi\r\n-});\r\n-\r\n-export default async function handler(req, res) {\r\n-    applyCors(res);\r\n-\r\n-    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n-    if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\r\n-\r\n-    const { socket_id, channel_name, user_id, username, name, ip, host, time } = req.body;\r\n-\r\n-    const presenceData = {\r\n-        user_id,\r\n-        user_info: {\r\n-            username: username || name,\r\n-            name: name || username,\r\n-            ip: ip ?? \"-\",\r\n-            host: host ?? \"-\",\r\n-            time: time ?? new Date().toISOString()\r\n-        }\r\n-    };\r\n-\r\n-    try {\r\n-        const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n-        return res.send(auth);\r\n-    } catch (err) {\r\n-        console.error(\"ABLY AUTH ERROR:\", err);\r\n-        return res.status(500).json({ error: \"Auth failed\" });\r\n-    }\r\n-}\r\n-import Pusher from \"pusher\";\r\n-import { applyCors } from '../_cors.js';\r\n-\r\n-export const config = {\r\n-    runtime: \"nodejs\",\r\n-};\r\n-\r\n-const pusher = new Pusher({\r\n-    appId: process.env.PUSHER_APP_ID,\r\n-    key: process.env.PUSHER_KEY,\r\n-    secret: process.env.PUSHER_SECRET,\r\n-    cluster: process.env.PUSHER_CLUSTER,\r\n-    useTLS: true,\r\n-});\r\n-\r\n-export default async function handler(req, res) {\r\n-    applyCors(res);\r\n-\r\n-    if (req.method === \"OPTIONS\") {\r\n-        return res.status(200).end();\r\n-    }\r\n-\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ error: \"Method not allowed\" });\r\n-    }\r\n-\r\n-    const { socket_id, channel_name, user_id, username, ip, host } = req.body;\r\n-\r\n-    if (!user_id || !username) {\r\n-        return res.status(400).json({ error: \"Missing user data\" });\r\n-    }\r\n-\r\n-    const presenceData = {\r\n-        user_id,\r\n-        user_info: {\r\n-            username,\r\n-            ip: ip || \"-\",\r\n-            host: host || \"-\",\r\n-        },\r\n-    };\r\n-\r\n-    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n-    res.send(auth);\r\n-}\r\n-import Pusher from \"pusher\";\r\n-import { applyCors } from '../_cors.js';\r\n-\r\n-export const config = {\r\n-    runtime: \"nodejs\",\r\n-};\r\n-\r\n-const pusher = new Pusher({\r\n-    appId: process.env.PUSHER_APP_ID,\r\n-    key: process.env.PUSHER_KEY,\r\n-    secret: process.env.PUSHER_SECRET,\r\n-    cluster: process.env.PUSHER_CLUSTER,\r\n-    useTLS: true,\r\n-});\r\n-\r\n-export default async function handler(req, res) {\r\n-    applyCors(res);\r\n-    if (req.method !== \"POST\") {\r\n-        return res.status(405).json({ error: \"Method not allowed\" });\r\n-    }\r\n-\r\n-    const { socket_id, channel_name, user_id, username } = req.body;\r\n-\r\n-    if (!user_id || !username) {\r\n-        return res.status(400).json({ error: \"Missing user data\" });\r\n-    }\r\n-\r\n-    const presenceData = {\r\n-        user_id,\r\n-        user_info: { username },\r\n-    };\r\n-\r\n-    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n-\r\n-    res.send(auth);\r\n-}\r\n"
                },
                {
                    "date": 1765237511281,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,80 @@\n+// FINAL VERSION ‚Äî AUTH SERVICE ABLY (PUSHER PROTOCOL MODE)\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// IP yang diizinkan melakukan monitoring (hanya dashboard admin)\r\n+const ALLOWED_IP = \"182.168.0.235\";\r\n+\r\n+// Setup Ably (REST Pusher Protocol)\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID, // ex: R2yUfw\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`, // ex: R2yUfw.3C47dg\r\n+    secret: process.env.ABLY_KEY_SECRET, // ex: shDrY-...\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const {\r\n+        socket_id,\r\n+        channel_name,\r\n+        user_id,\r\n+        username,\r\n+        name,\r\n+        ip,\r\n+        host,\r\n+        time,\r\n+    } = req.body;\r\n+\r\n+    /* =======================================================\r\n+        üîê 1. SECURITY CHECK ‚Äî FILTER IP\r\n+        HANYA IP tertentu yang boleh subscribe presence channel\r\n+    ======================================================== */\r\n+    if (ip !== ALLOWED_IP) {\r\n+        return res.status(403).json({\r\n+            error: \"Access denied: Your device is not allowed to subscribe.\",\r\n+        });\r\n+    }\r\n+\r\n+    /* =======================================================\r\n+        2. Data presence user\r\n+    ======================================================== */\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    /* =======================================================\r\n+        3. AUTHENTICATE ke Ably (Pusher Protocol)\r\n+    ======================================================== */\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({\r\n+            error: \"Auth failed\",\r\n+            message: err.message,\r\n+        });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765239558951,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,82 @@\n+// FINAL VERSION ‚Äî AUTH SERVICE ABLY (PUSHER PROTOCOL MODE)\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// IP yang diizinkan melakukan monitoring (hanya dashboard admin)\r\n+const ALLOW_IP = \"182.168.0.235\";\r\n+const ALLOW_MAC = \"A4-BB-6D-BA-66-F4\"; // contoh dari log kamu\r\n+\r\n+// Setup Ably (REST Pusher Protocol)\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID, // ex: R2yUfw\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`, // ex: R2yUfw.3C47dg\r\n+    secret: process.env.ABLY_KEY_SECRET, // ex: shDrY-...\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const {\r\n+        socket_id,\r\n+        channel_name,\r\n+        user_id,\r\n+        username,\r\n+        name,\r\n+        ip,\r\n+        host,\r\n+        time,\r\n+    } = req.body;\r\n+\r\n+    /* =======================================================\r\n+        üîê 1. SECURITY CHECK ‚Äî FILTER IP\r\n+        HANYA IP tertentu yang boleh subscribe presence channel\r\n+    ======================================================== */\r\n+\r\n+    if (ip !== ALLOW_IP && host !== ALLOW_MAC) {\r\n+        return res.status(403).json({\r\n+            error: \"Access denied: Your device is not allowed to subscribe.\",\r\n+        });\r\n+    }\r\n+\r\n+    /* =======================================================\r\n+        2. Data presence user\r\n+    ======================================================== */\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    /* =======================================================\r\n+        3. AUTHENTICATE ke Ably (Pusher Protocol)\r\n+    ======================================================== */\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({\r\n+            error: \"Auth failed\",\r\n+            message: err.message,\r\n+        });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765239579364,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,82 @@\n+// FINAL VERSION ‚Äî AUTH SERVICE ABLY (PUSHER PROTOCOL MODE)\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// IP yang diizinkan melakukan monitoring (hanya dashboard admin)\r\n+const ALLOW_IP = \"182.168.0.235\";\r\n+const ALLOW_MAC = \"A4-BB-6D-BA-66-F4\"; // contoh dari log kamu\r\n+\r\n+// Setup Ably (REST Pusher Protocol)\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID, // ex: R2yUfw\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`, // ex: R2yUfw.3C47dg\r\n+    secret: process.env.ABLY_KEY_SECRET, // ex: shDrY-...\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const {\r\n+        socket_id,\r\n+        channel_name,\r\n+        user_id,\r\n+        username,\r\n+        name,\r\n+        ip,\r\n+        host,\r\n+        time,\r\n+    } = req.body;\r\n+\r\n+    /* =======================================================\r\n+        üîê 1. SECURITY CHECK ‚Äî FILTER IP\r\n+        HANYA IP tertentu yang boleh subscribe presence channel\r\n+    ======================================================== */\r\n+\r\n+    if (ip !== ALLOW_IP && host !== ALLOW_MAC) {\r\n+        return res.status(403).json({\r\n+            error: \"Access denied: Your device is not allowed to subscribe.\",\r\n+        });\r\n+    }\r\n+\r\n+    /* =======================================================\r\n+        2. Data presence user\r\n+    ======================================================== */\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    /* =======================================================\r\n+        3. AUTHENTICATE ke Ably (Pusher Protocol)\r\n+    ======================================================== */\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({\r\n+            error: \"Auth failed\",\r\n+            message: err.message,\r\n+        });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765242371155,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,44 @@\n+// auth.js ‚Äî versi Ably Pusher-Compatible\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from '../_cors.js';\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// Gunakan REST endpoint Ably dengan Pusher Protocol\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID,            // R2yUfw\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`,\r\n+    secret: process.env.ABLY_KEY_SECRET,       // shDrY-...\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, username, name, ip, host, time } = req.body;\r\n+\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username: username || name,\r\n+            name: name || username,\r\n+            ip: ip ?? \"-\",\r\n+            host: host ?? \"-\",\r\n+            time: time ?? new Date().toISOString()\r\n+        }\r\n+    };\r\n+\r\n+    try {\r\n+        const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        console.error(\"ABLY AUTH ERROR:\", err);\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765247288697,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,64 @@\n+// AUTH.PRESENCE ‚Üí semua user boleh masuk presence\r\n+// AUTH.SUBSCRIBE ‚Üí hanya SMG yang boleh subscribe\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+const ALLOW_DASHBOARD_IP = \"182.168.0.235\";\r\n+const ALLOW_DASHBOARD_ROLES = [\"SMG\"];\r\n+\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID,\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`,\r\n+    secret: process.env.ABLY_KEY_SECRET,\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, name, username, ip, host, role, time } = req.body;\r\n+\r\n+    // semua user tetap diizinkan masuk presence ‚Üí supaya terdeteksi online/offline\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username,\r\n+            name: name || username, // fallback\r\n+            ip,\r\n+            host,\r\n+            role,\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    // üî• Filtering khusus SUBSCRIPTION untuk dashboard\r\n+    const isDashboard =\r\n+        ip === ALLOW_DASHBOARD_IP &&\r\n+        ALLOW_DASHBOARD_ROLES.includes(role);\r\n+\r\n+    if (!isDashboard && channel_name === \"presence-dashboard\") {\r\n+        // Channel dashboard khusus admin SMG\r\n+        return res.status(403).json({ error: \"Access denied: not SMG dashboard user\" });\r\n+    }\r\n+\r\n+    // Untuk presence-online ‚Üí SELALU berhasil (agar semua user tercatat)\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765247319229,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,63 @@\n+// AUTH.PRESENCE ‚Üí semua user boleh masuk presence\r\n+// AUTH.SUBSCRIBE ‚Üí hanya SMG yang boleh subscribe\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+// const ALLOW_DASHBOARD_IP = \"182.168.0.235\";\r\n+const ALLOW_DASHBOARD_ROLES = [\"SMG\"];\r\n+\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID,\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`,\r\n+    secret: process.env.ABLY_KEY_SECRET,\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method === \"OPTIONS\") return res.status(200).end();\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, name, username, ip, host, role, time } = req.body;\r\n+\r\n+    // semua user tetap diizinkan masuk presence ‚Üí supaya terdeteksi online/offline\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username,\r\n+            name: name || username, // fallback\r\n+            ip,\r\n+            host,\r\n+            role,\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    // üî• Filtering khusus SUBSCRIPTION untuk dashboard\r\n+    const isDashboard =\r\n+        ALLOW_DASHBOARD_ROLES.includes(role);\r\n+\r\n+    if (!isDashboard && channel_name === \"presence-dashboard\") {\r\n+        // Channel dashboard khusus admin SMG\r\n+        return res.status(403).json({ error: \"Access denied: not SMG dashboard user\" });\r\n+    }\r\n+\r\n+    // Untuk presence-online ‚Üí SELALU berhasil (agar semua user tercatat)\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1765267576963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,62 @@\n+// AUTH presence-all + SUBSCRIBE for SMG only\r\n+import Pusher from \"pusher\";\r\n+import { applyCors } from \"../_cors.js\";\r\n+\r\n+export const config = { runtime: \"nodejs\" };\r\n+\r\n+const ALLOW_IP = \"182.168.0.235\";\r\n+const ALLOW_ROLES = [\"SMG\"];\r\n+\r\n+const pusher = new Pusher({\r\n+    appId: process.env.ABLY_APP_ID,\r\n+    key: `${process.env.ABLY_APP_ID}.${process.env.ABLY_KEY_ID}`,\r\n+    secret: process.env.ABLY_KEY_SECRET,\r\n+    host: \"rest-pusher.ably.io\",\r\n+    port: 443,\r\n+    scheme: \"https\",\r\n+    useTLS: true,\r\n+});\r\n+\r\n+export default async function handler(req, res) {\r\n+    applyCors(res);\r\n+\r\n+    if (req.method !== \"POST\")\r\n+        return res.status(405).json({ error: \"Method not allowed\" });\r\n+\r\n+    const { socket_id, channel_name, user_id, username, name, ip, host, role, time } = req.body;\r\n+\r\n+    // üîµ Semua user boleh masuk presence-online agar dashboard bisa lihat mereka\r\n+    const presenceData = {\r\n+        user_id,\r\n+        user_info: {\r\n+            username,\r\n+            name,\r\n+            ip,\r\n+            host,\r\n+            role,\r\n+            time: time ?? new Date().toISOString(),\r\n+        },\r\n+    };\r\n+\r\n+    // üî¥ FILTER SUBSCRIBE khusus role SMG\r\n+    const isDashboardSMG = (role === \"SMG\" && ip === ALLOW_IP);\r\n+\r\n+    // Jika bukan SMG, dan channel ini adalah CHANNEL DASHBOARD\r\n+    if (channel_name === \"presence-online\" && !isDashboardSMG) {\r\n+        // Jangan izinkan subscribe\r\n+        // tapi user tetap boleh authenticate (agar counted sebagai online)\r\n+        return res.status(403).json({ error: \"Only SMG can subscribe to dashboard\" });\r\n+    }\r\n+\r\n+    // üîµ Authenticate normal\r\n+    try {\r\n+        const auth = pusher.authenticate(\r\n+            socket_id,\r\n+            channel_name,\r\n+            presenceData\r\n+        );\r\n+        return res.send(auth);\r\n+    } catch (err) {\r\n+        return res.status(500).json({ error: \"Auth failed\" });\r\n+    }\r\n+}\r\n"
                }
            ],
            "date": 1764814520744,
            "name": "Commit-0",
            "content": "import Pusher from \"pusher\";\r\nimport { applyCors } from '../_cors.js';\r\n\r\nexport const config = {\r\n    runtime: \"nodejs\",\r\n};\r\n\r\nconst pusher = new Pusher({\r\n    appId: process.env.PUSHER_APP_ID,\r\n    key: process.env.PUSHER_KEY,\r\n    secret: process.env.PUSHER_SECRET,\r\n    cluster: process.env.PUSHER_CLUSTER,\r\n    useTLS: true,\r\n});\r\n\r\nexport default async function handler(req, res) {\r\n    applyCors(res);\r\n    if (req.method !== \"POST\") {\r\n        return res.status(405).json({ error: \"Method not allowed\" });\r\n    }\r\n\r\n    const { socket_id, channel_name, user_id, username } = req.body;\r\n\r\n    if (!user_id || !username) {\r\n        return res.status(400).json({ error: \"Missing user data\" });\r\n    }\r\n\r\n    const presenceData = {\r\n        user_id,\r\n        user_info: { username },\r\n    };\r\n\r\n    const auth = pusher.authenticate(socket_id, channel_name, presenceData);\r\n\r\n    res.send(auth);\r\n}\r\n"
        }
    ]
}