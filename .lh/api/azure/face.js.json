{
    "sourceFile": "api/azure/face.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765951669103,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765951669103,
            "name": "Commit-0",
            "content": "const { randomUUID } = require(\"crypto\");\r\n\r\nconst { AzureKeyCredential } = require(\"@azure/core-auth\");\r\n\r\nconst createFaceClient = require(\"@azure-rest/ai-vision-face\").default,\r\n    { getLongRunningPoller } = require(\"@azure-rest/ai-vision-face\");\r\n\r\nconst sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\nconst main = async () => {\r\n    const endpoint = process.env[\"FACE_ENDPOINT\"] ?? \"<endpoint>\";\r\n    const apikey = process.env[\"FACE_APIKEY\"] ?? \"<apikey>\";\r\n    const credential = new AzureKeyCredential(apikey);\r\n    const client = createFaceClient(endpoint, credential);\r\n\r\n    const imageBaseUrl =\r\n        \"https://raw.githubusercontent.com/Azure-Samples/cognitive-services-sample-data-files/master/Face/images/\";\r\n    const largePersonGroupId = randomUUID();\r\n\r\n    console.log(\"========IDENTIFY FACES========\");\r\n    console.log();\r\n\r\n    // Create a dictionary for all your images, grouping similar ones under the same key.\r\n    const personDictionary = {\r\n        \"Family1-Dad\": [\"Family1-Dad1.jpg\", \"Family1-Dad2.jpg\"],\r\n        \"Family1-Mom\": [\"Family1-Mom1.jpg\", \"Family1-Mom2.jpg\"],\r\n        \"Family1-Son\": [\"Family1-Son1.jpg\", \"Family1-Son2.jpg\"],\r\n    };\r\n\r\n    // A group photo that includes some of the persons you seek to identify from your dictionary.\r\n    const sourceImageFileName = \"identification1.jpg\";\r\n\r\n    // Create a large person group.\r\n    console.log(`Creating a person group with ID: ${largePersonGroupId}`);\r\n    await client.path(\"/largepersongroups/{largePersonGroupId}\", largePersonGroupId).put({\r\n        body: {\r\n            name: largePersonGroupId,\r\n            recognitionModel: \"recognition_04\",\r\n        },\r\n    });\r\n\r\n    // The similar faces will be grouped into a single large person group person.\r\n    console.log(\"Adding faces to person group...\");\r\n    await Promise.all(\r\n        Object.keys(personDictionary).map(async (name) => {\r\n            console.log(`Create a persongroup person: ${name}`);\r\n            const createLargePersonGroupPersonResponse = await client\r\n                .path(\"/largepersongroups/{largePersonGroupId}/persons\", largePersonGroupId)\r\n                .post({\r\n                    body: { name },\r\n                });\r\n\r\n            const { personId } = createLargePersonGroupPersonResponse.body;\r\n\r\n            await Promise.all(\r\n                personDictionary[name].map(async (similarImage) => {\r\n                    // Check if the image is of sufficent quality for recognition.\r\n                    const detectResponse = await client.path(\"/detect\").post({\r\n                        contentType: \"application/json\",\r\n                        queryParameters: {\r\n                            detectionModel: \"detection_03\",\r\n                            recognitionModel: \"recognition_04\",\r\n                            returnFaceId: false,\r\n                            returnFaceAttributes: [\"qualityForRecognition\"],\r\n                        },\r\n                        body: { url: `${imageBaseUrl}${similarImage}` },\r\n                    });\r\n\r\n                    const sufficientQuality = detectResponse.body.every(\r\n                        (face) => face.faceAttributes?.qualityForRecognition === \"high\",\r\n                    );\r\n                    if (!sufficientQuality) {\r\n                        return;\r\n                    }\r\n\r\n                    if (detectResponse.body.length != 1) {\r\n                        return;\r\n                    }\r\n\r\n                    // Quality is sufficent, add to group.\r\n                    console.log(\r\n                        `Add face to the person group person: (${name}) from image: (${similarImage})`,\r\n                    );\r\n                    await client\r\n                        .path(\r\n                            \"/largepersongroups/{largePersonGroupId}/persons/{personId}/persistedfaces\",\r\n                            largePersonGroupId,\r\n                            personId,\r\n                        )\r\n                        .post({\r\n                            queryParameters: { detectionModel: \"detection_03\" },\r\n                            body: { url: `${imageBaseUrl}${similarImage}` },\r\n                        });\r\n                }),\r\n            );\r\n        }),\r\n    );\r\n    console.log(\"Done adding faces to person group.\");\r\n\r\n    // Start to train the large person group.\r\n    console.log();\r\n    console.log(`Training person group: ${largePersonGroupId}`);\r\n    const trainResponse = await client\r\n        .path(\"/largepersongroups/{largePersonGroupId}/train\", largePersonGroupId)\r\n        .post();\r\n    const poller = await getLongRunningPoller(client, trainResponse);\r\n    await poller.pollUntilDone();\r\n    console.log(`Training status: ${poller.getOperationState().status}`);\r\n    if (poller.getOperationState().status !== \"succeeded\") {\r\n        return;\r\n    }\r\n\r\n    console.log(\"Pausing for 60 seconds to avoid triggering rate limit on free account...\");\r\n    await sleep(60000);\r\n\r\n    // Detect faces from source image url and only take those with sufficient quality for recognition.\r\n    const detectResponse = await client.path(\"/detect\").post({\r\n        contentType: \"application/json\",\r\n        queryParameters: {\r\n            detectionModel: \"detection_03\",\r\n            recognitionModel: \"recognition_04\",\r\n            returnFaceId: true,\r\n            returnFaceAttributes: [\"qualityForRecognition\"],\r\n        },\r\n        body: { url: `${imageBaseUrl}${sourceImageFileName}` },\r\n    });\r\n    const faceIds = detectResponse.body.filter((face) => face.faceAttributes?.qualityForRecognition !== \"low\").map((face) => face.faceId);\r\n\r\n    // Identify the faces in a large person group.\r\n    const identifyResponse = await client.path(\"/identify\").post({\r\n        body: { faceIds, largePersonGroupId: largePersonGroupId },\r\n    });\r\n    await Promise.all(\r\n        identifyResponse.body.map(async (result) => {\r\n            try {\r\n                const getLargePersonGroupPersonResponse = await client\r\n                    .path(\r\n                        \"/largepersongroups/{largePersonGroupId}/persons/{personId}\",\r\n                        largePersonGroupId,\r\n                        result.candidates[0].personId,\r\n                    )\r\n                    .get();\r\n                const person = getLargePersonGroupPersonResponse.body;\r\n                console.log(\r\n                    `Person: ${person.name} is identified for face in: ${sourceImageFileName} with ID: ${result.faceId}. Confidence: ${result.candidates[0].confidence}`,\r\n                );\r\n\r\n                // Verification:\r\n                const verifyResponse = await client.path(\"/verify\").post({\r\n                    body: {\r\n                        faceId: result.faceId,\r\n                        largePersonGroupId: largePersonGroupId,\r\n                        personId: person.personId,\r\n                    },\r\n                });\r\n                console.log(\r\n                    `Verification result between face ${result.faceId} and person ${person.personId}: ${verifyResponse.body.isIdentical} with confidence: ${verifyResponse.body.confidence}`,\r\n                );\r\n            } catch (error) {\r\n                console.log(`No persons identified for face with ID ${result.faceId}`);\r\n            }\r\n        }),\r\n    );\r\n    console.log();\r\n\r\n    // Delete large person group.\r\n    console.log(`Deleting person group: ${largePersonGroupId}`);\r\n    await client.path(\"/largepersongroups/{largePersonGroupId}\", largePersonGroupId).delete();\r\n    console.log();\r\n\r\n    console.log(\"Done.\");\r\n};\r\n\r\nmain().catch(console.error);"
        }
    ]
}