{
    "sourceFile": "api/simpan-data.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1761877193024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1761890021203,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,6 @@\n // api/simpan-data.js\r\n-\r\n+import 'dotenv/config'\r\n import mysql from \"mysql2/promise\"\r\n \r\n export default async function handler(req, res) {\r\n   // Add CORS headers\r\n"
                }
            ],
            "date": 1761877193024,
            "name": "Commit-0",
            "content": "// api/simpan-data.js\r\n\r\nimport mysql from \"mysql2/promise\"\r\n\r\nexport default async function handler(req, res) {\r\n  // Add CORS headers\r\n  res.setHeader(\"Access-Control-Allow-Credentials\", true)\r\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\") // Allow any origin\r\n  // res.setHeader('Access-Control-Allow-Origin', 'https://yourdomain.com') // Or restrict to specific domains\r\n  res.setHeader(\"Access-Control-Allow-Methods\", \"GET,OPTIONS,PATCH,DELETE,POST,PUT\")\r\n  res.setHeader(\r\n    \"Access-Control-Allow-Headers\",\r\n    \"X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version\",\r\n  )\r\n\r\n  // Handle OPTIONS request (preflight)\r\n  if (req.method === \"OPTIONS\") {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  // Only allow POST requests for actual data processing\r\n  if (req.method !== \"POST\") {\r\n    return res.status(405).json({ message: \"Method Not Allowed\" })\r\n  }\r\n\r\n  // Initialize connection variable outside try block to use in finally\r\n  let connection\r\n\r\n  try {\r\n    console.log(\"Request received:\", { method: req.method })\r\n\r\n    // Extract data from request body\r\n    const { data, hasil, tanggal } = req.body\r\n\r\n    // Validate required fields\r\n    if (!data || !hasil || !tanggal) {\r\n      return res.status(400).json({\r\n        message: \"Data tidak lengkap\",\r\n        received: {\r\n          data: !!data,\r\n          hasil: !!hasil,\r\n          tanggal: !!tanggal,\r\n        },\r\n      })\r\n    }\r\n\r\n    // Log connection attempt\r\n    console.log(\"Connecting to database...\")\r\n\r\n    // Create database connection with the correct port\r\n    connection = await mysql.createConnection({\r\n      host: process.env.DB_HOST || \"337job.h.filess.io\",\r\n      port: 3306, // Add the port\r\n      user: process.env.DB_USER || \"didik_anak_platejarto\",\r\n      password: process.env.DB_PASSWORD || \"92d2bcef0121274121b801e495adc80be49679f0\",\r\n      database: process.env.DB_NAME || \"didik_anak_platejarto\",\r\n      connectTimeout: 15000,\r\n    })\r\n\r\n    console.log(\"Database connection successful\")\r\n\r\n    // Create table if it doesn't exist\r\n    await connection.execute(`\r\n      CREATE TABLE IF NOT EXISTS laporan_kanker (\r\n        id INT AUTO_INCREMENT PRIMARY KEY,\r\n        data_form JSON,\r\n        hasil VARCHAR(20),\r\n        tanggal DATETIME\r\n      )\r\n    `)\r\n\r\n    console.log(\"Table verified/created\")\r\n\r\n    // Insert data into the table\r\n    const [result] = await connection.execute(\r\n      `INSERT INTO laporan_kanker (data_form, hasil, tanggal)\r\n       VALUES (?, ?, ?)`,\r\n      [\r\n        JSON.stringify(data), // Store data as JSON string\r\n        hasil,\r\n        tanggal,\r\n      ],\r\n    )\r\n\r\n    console.log(\"Data inserted successfully:\", { insertId: result.insertId })\r\n\r\n    // Return success response\r\n    res.status(200).json({\r\n      message: \"Data berhasil disimpan ke database\",\r\n      insertId: result.insertId,\r\n    })\r\n  } catch (error) {\r\n    // Log the full error for debugging\r\n    console.error(\"Gagal menyimpan data:\", error)\r\n\r\n    // Return appropriate error message based on error type\r\n    if (error.code === \"ETIMEDOUT\" || error.code === \"ECONNREFUSED\") {\r\n      res.status(500).json({\r\n        message: \"Tidak dapat terhubung ke database - Database tidak dapat diakses\",\r\n        error: error.code,\r\n        solution: \"Periksa konfigurasi database dan pastikan port 3307 terbuka\",\r\n      })\r\n    } else if (error.code === \"ER_ACCESS_DENIED_ERROR\") {\r\n      res.status(500).json({\r\n        message: \"Akses ke database ditolak - Kredensial tidak valid\",\r\n        error: \"Access denied\",\r\n        solution: \"Periksa username dan password\",\r\n      })\r\n    } else {\r\n      res.status(500).json({\r\n        message: \"Terjadi kesalahan server\",\r\n        error: error.message,\r\n        details: error.code,\r\n      })\r\n    }\r\n  } finally {\r\n    // Close the connection if it was established\r\n    if (connection) {\r\n      try {\r\n        await connection.end()\r\n        console.log(\"Database connection closed\")\r\n      } catch (err) {\r\n        console.error(\"Error closing database connection:\", err)\r\n      }\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}